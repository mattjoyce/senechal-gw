# Ductile - TEST Environment Configuration
# This configuration is specifically for testing development changes

service:
  name: ductile-test
  tick_interval: 30s           # Faster ticks for testing
  log_level: debug             # Verbose logging for debugging
  log_format: json
  dedupe_ttl: 1h               # Shorter TTL for testing
  job_log_retention: 24h       # 1 day retention for test

state:
  path: ./data/ductile-test.db  # Separate test database

# API Server: ENABLED for testing
api:
  enabled: true
  listen: "0.0.0.0:8080"       # Listen on all interfaces in container
  auth:
    tokens:
      - token: ${DUCTILE_TOKEN_ADMIN}
        scopes: ["*"]
      - token: ${DUCTILE_TOKEN_READONLY}
        scopes: ["plugin:ro", "job:ro", "state:ro"]

plugins_dir: ./plugins

plugins:
  # Echo plugin for basic testing
  echo:
    enabled: true
    schedule:
      every: 5m                # Minimum allowed interval
      jitter: 10s
    timeout: 30s
    max_attempts: 3
    circuit_breaker:
      threshold: 3
      reset_after: 2m          # Faster reset for testing
    config:
      message: "Test environment echo - ${DUCTILE_TEST_MESSAGE}"

  # File handler for pipeline testing (event-driven, not scheduled)
  file_handler:
    enabled: true
    timeout: 30s
    max_attempts: 1
    config:
      allowed_read_paths: "/tmp"
      allowed_write_paths: "/tmp"

  # Fabric plugin for text analysis (event-driven via routing)
  fabric:
    enabled: true
    timeout: 120s
    max_attempts: 1
    config:
      FABRIC_DEFAULT_MODEL: "gpt-4"

# Routes: event-driven plugin chaining for multi-plugin pipeline
routes:
  # Step 1: file.read → fabric (analyze text)
  - from: file_handler
    event_type: file.read
    to: fabric

  # Step 2: fabric.completed → file_handler (write report)
  - from: fabric
    event_type: fabric.completed
    to: file_handler

# Webhooks: HTTP listener endpoints (for testing webhooks)
# webhooks:
#   test:
#     path: /webhook/test
#     secret: ${TEST_WEBHOOK_SECRET}
#     route_to: echo
