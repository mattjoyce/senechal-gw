---
id: 104
status: todo
priority: High
blocked_by: [103]
assignee: "@gemini"
tags: [plugin, agent, llm, eino, golang]
---

# #104: Agent Loop Plugin (Go + Eino)

Implement the intelligent "Agent Loop" logic using Go and the Eino framework. This plugin replaces the Python prototype and implements a dynamic Frame→Plan→Act→Reflect loop.

## Workspace Specification (The "Paper Trail")

The agent must manage the following files within its `workspace_dir` to maintain state and provide observability.

### 1. `context.md` (The Goal)
**Purpose:** Stores the seed information.
**Content:**
- The original `goal` from the trigger.
- Any provided `context` (constraints, preferences).

### 2. `memory.md` (Working Memory)
**Purpose:** The agent's internal "scratchpad" for facts and progress.
**Content:**
- **Definition of Done:** A checklist of 3–7 items derived from the goal.
- **Learned Facts:** Bullet points of info retrieved from tools.
- **Status:** Current progress against the goal.

### 3. `skills.md` (Tool Catalog)
**Purpose:** A human/LLM-readable list of available tools.
**Content:**
- Generated by calling `ductile system skills`.
- Lists plugin names, commands, and required config/payload fields.

### 4. `plan.md` (The Todo List)
**Purpose:** The roadmap for the task.
**Content:**
- **Step List:** A sequence of high-level steps.
- **Next Action:** Exactly one tool call the agent has decided to execute next.
- **Rationale:** Why this tool was chosen.

### 5. `decisions.md` (The Audit Log)
**Purpose:** A narrative log of the agent's reasoning.
**Content:**
- **Phase Entries:** Detailed record of what the agent thought during each Frame/Plan/Reflect phase.
- **Reflections:** Analysis of tool results and adjustments to the plan.

## Safety & Budgeting
To prevent runaway execution:
- **`max_loops`**: A hard limit on the number of turns. Default: 10.
- **Enforcement**: If `step >= max_loops`, the agent MUST stop and emit an `agent.escalated` event.

## Implementation Logic for Junior Devs
Each "Turn" (triggered by an event) follows this sequence:
1. **Load:** Read current state from the database and `.md` files in the workspace.
2. **Phase: Frame:** (Turn 1 only) Analyze `context.md` and write the "Definition of Done" to `memory.md`.
3. **Phase: Plan:** Look at `memory.md` and `skills.md`. Update `plan.md` with the "Next Action."
4. **Phase: Act:** Emit the `agentic.tool_request` event and save `pending_tool` to the database.
5. **Phase: Reflect:** (Resume turns only) Update `memory.md` with the tool result, check if the goal is met, and decide to `continue` or `finish`.

## Acceptance Criteria
- [ ] Go-based plugin using Eino for LLM orchestration.
- [ ] Automatically creates and maintains all 5 Markdown files.
- [ ] Correctly resumes execution using `run_id` and `step` correlation.
- [ ] Enforces `max_loops` safety limit.
- [ ] Emits `agent.completed` only when all "Definition of Done" items are checked.

## Narrative
- 2026-02-16: Created card #104 with detailed workspace spec and safety limits. (by @gemini)
